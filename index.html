<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Jewelry Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .loader { border: 4px solid #e2e8f0; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .upload-box { transition: background-color 0.3s, border-color 0.3s; }
        .upload-box:hover { background-color: #f4f4f5; border-color: #6366f1; }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-12">
            <h1 class="font-playfair text-5xl md:text-6xl font-bold text-gray-900">Visual Search</h1>
            <p class="mt-3 text-lg text-gray-600 max-w-2xl mx-auto">Discover jewelry by image. Add your own pieces to the collection and find the perfect match.</p>
        </header>

        <div class="max-w-5xl mx-auto">
            
            <!-- NEW: Search View Container -->
            <div id="searchView">
                <!-- Main Search Upload -->
                <div id="searchContainer" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-12 transition-opacity duration-300">
                    <h2 class="font-playfair text-3xl font-bold text-gray-900 mb-6 text-center">Search with Your Image</h2>
                    <div class="flex flex-col md:flex-row items-center gap-6">
                        <div class="flex-shrink-0">
                            <input type="file" id="mainImageUpload" class="hidden" accept="image/*" onchange="handleMainImageUpload(event)">
                            <label for="mainImageUpload" class="cursor-pointer flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-xl p-6 text-center h-48 w-48 upload-box">
                                <img id="uploadedImagePreview" class="hidden h-full w-full object-cover rounded-lg" alt="Uploaded Preview">
                                <div id="mainUploadIcon" class="flex flex-col items-center">
                                    <svg class="w-10 h-10 text-indigo-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                    <p class="font-semibold text-indigo-600">Click to Upload</p>
                                </div>
                            </label>
                        </div>
                        <div class="flex-grow w-full">
                            <label for="mainTextQuery" class="font-semibold text-gray-700 mb-2 block">Refine with text (optional)</label>
                            <input type="text" id="mainTextQuery" placeholder="e.g., 'in white gold' or 'with ruby stones'" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                            <button type="button" onclick="executeUploadSearch()" class="mt-4 w-full bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 font-bold text-lg">Search Collection</button>
                        </div>
                    </div>
                </div>

                <!-- Add to Collection -->
                <div class="bg-gray-50 rounded-2xl shadow-lg p-6 md:p-8 mb-12">
                    <h2 class="font-playfair text-3xl font-bold text-gray-900 mb-6 text-center">Add Your Own Images to the Collection</h2>
                    <div class="flex flex-col md:flex-row items-center gap-6">
                         <div class="flex-shrink-0">
                            <input type="file" id="addImageUpload" class="hidden" accept="image/*" onchange="handleAddImageUpload(event)">
                            <label for="addImageUpload" class="cursor-pointer flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-xl p-6 text-center h-48 w-48 upload-box">
                                 <img id="addImagePreview" class="hidden h-full w-full object-cover rounded-lg" alt="Add Preview">
                                <div id="addUploadIcon" class="flex flex-col items-center">
                                    <svg class="w-10 h-10 text-gray-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                    <p class="font-semibold text-gray-600">Select Image</p>
                                </div>
                            </label>
                        </div>
                        <div class="flex-grow w-full">
                            <p class="text-gray-600 mb-4">Upload a new jewelry image to permanently add it to the searchable collection. After adding, you must stop the server and re-run `python app.py index`.</p>
                            <button type="button" onclick="executeAddImage()" class="w-full bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 font-bold text-lg">Add to Collection</button>
                            <p id="addStatus" class="text-center mt-3 font-medium"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Results View Container -->
            <div id="resultsView" class="min-h-[300px] hidden">
                <div class="text-center mb-8">
                    <button type="button" onclick="resetSearch()" class="bg-gray-800 text-white px-8 py-3 rounded-lg hover:bg-black transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 font-bold text-lg">Start New Search</button>
                </div>

                <div id="comparisonSection" class="hidden mb-12">
                    <h2 class="font-playfair text-4xl font-bold text-gray-900 mb-8 text-center">Your Upload vs. Closest Match</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                        <div class="flex flex-col items-center">
                             <h3 class="font-semibold text-lg text-gray-700 mb-3">Your Image</h3>
                             <img id="comparisonUploadedImage" src="" class="rounded-xl shadow-lg w-full max-w-xs object-cover aspect-square">
                        </div>
                        <div class="flex flex-col items-center">
                            <h3 class="font-semibold text-lg text-gray-700 mb-3">Best Match</h3>
                            <div id="bestMatchCard" class="w-full max-w-xs"></div>
                        </div>
                    </div>
                </div>
                <div id="status" class="text-center"></div>
                <div id="resultsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-8"></div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const searchViewEl = document.getElementById('searchView');
        const resultsViewEl = document.getElementById('resultsView');
        const uploadedImagePreviewEl = document.getElementById('uploadedImagePreview');
        const mainUploadIconEl = document.getElementById('mainUploadIcon');
        const mainImageUploadInput = document.getElementById('mainImageUpload');
        const addImagePreviewEl = document.getElementById('addImagePreview');
        const addUploadIconEl = document.getElementById('addUploadIcon');
        const addStatusEl = document.getElementById('addStatus');
        const resultsGridEl = document.getElementById('resultsGrid');
        const statusEl = document.getElementById('status');
        const comparisonSectionEl = document.getElementById('comparisonSection');
        const comparisonUploadedImageEl = document.getElementById('comparisonUploadedImage');
        const bestMatchCardEl = document.getElementById('bestMatchCard');

        let fileToSearch = null;
        let uploadedImageSrc = '';
        let fileToAdd = null;

        // --- HANDLERS for FILE PREVIEWS ---
        function handleMainImageUpload(event) {
            fileToSearch = event.target.files[0];
            if (!fileToSearch) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImageSrc = e.target.result;
                uploadedImagePreviewEl.src = uploadedImageSrc;
                uploadedImagePreviewEl.classList.remove('hidden');
                mainUploadIconEl.classList.add('hidden');
            };
            reader.readAsDataURL(fileToSearch);
        }

        function handleAddImageUpload(event) {
            fileToAdd = event.target.files[0];
            if (!fileToAdd) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                addImagePreviewEl.src = e.target.result;
                addImagePreviewEl.classList.remove('hidden');
                addUploadIconEl.classList.add('hidden');
            };
            reader.readAsDataURL(fileToAdd);
        }

        // --- API CALLS & DISPLAY LOGIC ---
        async function executeUploadSearch() {
            if (!fileToSearch) {
                alert("Please upload an image to search.");
                return;
            }
            showLoadingState();

            const formData = new FormData();
            formData.append('image', fileToSearch);
            formData.append('query', document.getElementById('mainTextQuery').value);
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/upload_search', { method: 'POST', body: formData });
                
                const responseText = await response.text();
                if (!response.ok) {
                    try {
                        const errorJson = JSON.parse(responseText);
                        throw new Error(errorJson.error || "An unknown server error occurred.");
                    } catch (e) {
                        throw new Error(responseText || "An unknown server error occurred.");
                    }
                }

                const resultData = JSON.parse(responseText);
                console.log("✅ DEBUG: Data received from backend:", resultData);
                renderResults(resultData);
                localStorage.setItem('lastSearchResults', JSON.stringify(resultData));
                localStorage.setItem('lastUploadedImageSrc', uploadedImageSrc);


            } catch (error) {
                console.error("❌ DEBUG: API call failed:", error);
                displayError(error.message);
            }
        }

        async function executeAddImage() {
            if (!fileToAdd) {
                alert("Please select an image to add.");
                return;
            }
            addStatusEl.textContent = 'Uploading...';
            addStatusEl.className = 'text-center mt-3 font-medium text-gray-600';

            const formData = new FormData();
            formData.append('image', fileToAdd);

            try {
                const response = await fetch('http://127.0.0.1:5000/api/add_image', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    addStatusEl.textContent = result.message;
                    addStatusEl.className = 'text-center mt-3 font-medium text-green-600';
                } else {
                    throw new Error(result.error || "Failed to add image.");
                }
            } catch (error) {
                addStatusEl.textContent = `Upload failed: ${error.message}`;
                addStatusEl.className = 'text-center mt-3 font-medium text-red-600';
            }
        }

        // --- UI STATE MANAGEMENT ---
        function renderResults(searchResults) {
            statusEl.innerHTML = '';
            resultsGridEl.innerHTML = '';
            comparisonSectionEl.classList.add('hidden');
            
            if (!searchResults || searchResults.length === 0) {
                resultsGridEl.innerHTML = `<div class="col-span-full text-center my-12"><h3 class="font-semibold text-xl text-gray-800">No matches found for your image.</h3><p class="text-gray-500 mt-2">Try uploading a different image.</p></div>`;
            } else {
                const bestMatchItem = searchResults[0];
                comparisonUploadedImageEl.src = uploadedImageSrc;
                bestMatchCardEl.innerHTML = createCard(bestMatchItem);
                comparisonSectionEl.classList.remove('hidden');
                
                const otherResults = searchResults.slice(1);
                if (otherResults.length > 0) {
                    statusEl.innerHTML = `<h2 class="font-playfair text-4xl font-bold text-gray-900 mb-8">Other Similar Results</h2>`;
                    resultsGridEl.innerHTML = otherResults.map(item => createCard(item)).join('');
                } else {
                    statusEl.innerHTML = `<h2 class="font-playfair text-4xl font-bold text-gray-900 mb-8">Other Similar Results</h2>`;
                    resultsGridEl.innerHTML = `<div class="col-span-full text-center my-12"><h3 class="font-semibold text-xl text-gray-800">No other close matches were found.</h3></div>`;
                }
            }
            
            searchViewEl.classList.add('hidden');
            resultsViewEl.classList.remove('hidden');
        }

        function createCard(item) {
            const similarityPercent = item.distance !== undefined ? (1 - item.distance) * 100 : null;
            const distanceBadge = similarityPercent !== null
                ? `<div class="absolute top-2 right-2 bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow-md">Match: ${similarityPercent.toFixed(0)}%</div>`
                : '';
            
            return `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden group transform hover:-translate-y-2 transition-transform duration-300 ease-in-out relative">
                    ${distanceBadge}
                    <div class="aspect-w-1 aspect-h-1 w-full overflow-hidden bg-gray-100">
                       <img src="${item.image_path}" alt="${item.title}" class="w-full h-full object-cover object-center group-hover:scale-105 transition-transform duration-300">
                    </div>
                    <div class="p-4 text-center">
                        <h3 class="font-semibold text-gray-800 truncate">${item.title}</h3>
                        <p class="text-sm text-gray-500 capitalize">${item.category}</p>
                    </div>
                </div>
            `;
        }
        
        function displayError(message) {
             statusEl.innerHTML = '';
             resultsGridEl.innerHTML = `<div class="col-span-full text-center my-12 bg-red-100 text-red-700 p-4 rounded-lg"><h3 class="font-semibold">An Error Occurred</h3><p class="mt-2">${message}</p></div>`;
             comparisonSectionEl.classList.add('hidden');

             searchViewEl.classList.add('hidden');
             resultsViewEl.classList.remove('hidden');
        }

        function showLoadingState() {
            statusEl.innerHTML = `<div class="flex flex-col justify-center items-center my-12"><div class="loader"></div><p class="mt-4 text-gray-600">AI is searching...</p></div>`;
            resultsGridEl.innerHTML = '';
            comparisonSectionEl.classList.add('hidden');

            searchViewEl.classList.add('hidden');
            resultsViewEl.classList.remove('hidden');
        }

        function resetSearch() {
            console.log("resetSearch() called"); // Debug log as requested
            
            resultsViewEl.classList.add('hidden');
            
            fileToSearch = null;
            uploadedImageSrc = '';
            mainImageUploadInput.value = '';
            uploadedImagePreviewEl.src = '';
            uploadedImagePreviewEl.classList.add('hidden');
            mainUploadIconEl.classList.remove('hidden');
            document.getElementById('mainTextQuery').value = '';

            searchViewEl.classList.remove('hidden');
            localStorage.removeItem('lastSearchResults');
            localStorage.removeItem('lastUploadedImageSrc');

        }

        window.addEventListener('DOMContentLoaded', () => {
    const storedResults = localStorage.getItem('lastSearchResults');
    const storedImage = localStorage.getItem('lastUploadedImageSrc');
    
    if (storedResults && storedImage) {
        uploadedImageSrc = storedImage;
        const parsedResults = JSON.parse(storedResults);
        renderResults(parsedResults);
    }
});


    </script>
</body>
</html>

